<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Itin√©raire LoRaWAN</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; font-family: 'Arial', sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        #panel {
            position: absolute; top: 20px; right: 20px; z-index: 9999;
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); width: 250px;
        }
        h2 { margin-top: 0; font-size: 18px; color: #333; }
        .data { font-weight: bold; color: #007bff; }
        button {
            width: 100%; padding: 10px; margin-top: 10px;
            background: #ff4444; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        button:hover { background: #cc0000; }
    </style>
</head>
<body>

    <div id="panel">
        <h2>üìç Suivi Itin√©raire</h2>
        <p>Points captur√©s : <span id="count" class="data">0</span></p>
        <p>Derni√®re m√†j : <span id="lastTime" class="data">--:--:--</span></p>
        <hr>
        <div id="coords" style="font-size:0.9em; color:#555;">En attente...</div>
        <button onclick="resetPath()">üóëÔ∏è Effacer le trajet</button>
    </div>

    <div id="map"></div>

    <script>
        // --- 1. Initialisation Carte ---
        // Centr√© par d√©faut sur Paris (sera mis √† jour d√®s le 1er point)
        const map = L.map('map').setView([48.8566, 2.3522], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Variables globales
        let pathLine = L.polyline([], {color: 'red', weight: 5}).addTo(map);
        let currentMarker = L.marker([0,0], {opacity: 0}).addTo(map);
        const API_URL = "http://localhost:8000";

        // --- 2. Fonction de mise √† jour ---
        async function updateMap() {
            try {
                const response = await fetch(`${API_URL}/history`);
                const history = await response.json();

                document.getElementById('count').innerText = history.length;

                if (history.length > 0) {
                    // 1. Convertir l'historique pour Leaflet [[lat, lon], [lat, lon]...]
                    const latlngs = history.map(pt => [pt.lat, pt.lon]);
                    
                    // 2. Dessiner le trait rouge
                    pathLine.setLatLngs(latlngs);

                    // 3. Placer le marqueur sur le DERNIER point connu
                    const lastPt = history[history.length - 1];
                    const lastPos = [lastPt.lat, lastPt.lon];
                    
                    currentMarker.setLatLng(lastPos);
                    currentMarker.setOpacity(1); // Rendre visible
                    
                    // 4. Mettre √† jour le texte
                    document.getElementById('lastTime').innerText = lastPt.time;
                    document.getElementById('coords').innerHTML = 
                        `Lat: ${lastPt.lat.toFixed(5)}<br>Lon: ${lastPt.lon.toFixed(5)}`;

                    // Optionnel : Centrer la carte sur le dernier point (si on veut suivre)
                    // map.panTo(lastPos);
                }
            } catch (error) {
                console.error("Erreur connexion serveur:", error);
            }
        }

        // --- 3. Fonction Reset ---
        async function resetPath() {
            if(confirm("Voulez-vous effacer tout l'historique de d√©placement ?")) {
                await fetch(`${API_URL}/reset`, {method: 'POST'});
                pathLine.setLatLngs([]);
                currentMarker.setOpacity(0);
                document.getElementById('count').innerText = "0";
                updateMap();
            }
        }

        // --- 4. Boucle de rafra√Æchissement ---
        setInterval(updateMap, 2000); // V√©rifie toutes les 2 secondes
        updateMap();
    </script>
</body>
</html>